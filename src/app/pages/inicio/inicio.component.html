<!-- Indicador de modo edición (visible solo para admins) -->
<app-edit-mode-indicator></app-edit-mode-indicator>

<!-- Portada - Siempre visible, los elementos individuales manejan su loading -->
<div class="image-card-4">
  <!-- Imagen de fondo editable (fuera del flujo flex) -->
  <div class="hero-background-wrapper">
    <img *ngIf="getMediaSrc('hero-background')"
         [src]="getMediaSrc('hero-background')" 
         alt="Fondo Hero" 
         class="hero-background-image" 
         appEditableImage
         imageKey="hero-background"
         pageId="inicio"
         (imageChange)="onImageChange($event, 'hero-background')" />
  </div>
  
  <!-- Contenido del hero -->
  <div class="hero-content-wrapper">
    <div class="card-content">
      <div class="logo-container">
        <img *ngIf="getMediaSrc('hero-image')"
             [src]="getMediaSrc('hero-image')" 
             alt="Logo" 
             class="logo" 
             appEditableImage
             imageKey="hero-image"
             pageId="inicio"
             (imageChange)="onImageChange($event, 'hero-image')" />
      </div>
      <h2 appEditableContent 
          pageId="inicio" 
          contentId="hero-title"
          contentType="text"></h2>
    </div>
  </div>
</div>

<!-- Primer card. Video -->
<div class="psychologist-card">
  <div class="psychologist-card-content">
    <video *ngIf="getMediaSrc('hero-video')"
           controls
           appEditableVideo
           videoKey="hero-video"
           pageId="inicio"
           (videoChange)="onVideoChange($event, 'hero-video')">
      <source [src]="getMediaSrc('hero-video')" type="video/mp4" />
      Tu navegador no soporta la reproducción de video.
    </video>

    <div class="text-section">
      <h2 appEditableContent 
          pageId="inicio" 
          contentId="hero-subtitle"
          contentType="text"></h2>
      <p appEditableContent 
         pageId="inicio" 
         contentId="hero-description"
         contentType="text"></p>
      <a [routerLink]="'/formulario'" class="cta-button">Agendar cita</a>
    </div>
  </div>
</div>

<!-- Blog section mejorada -->
<div class="blog-section">
  <div class="section-header">
    <h1 class="blog-title" 
        appEditableContent 
        pageId="inicio" 
        contentId="blog-section-title"
        contentType="text"></h1>
    <p class="blog-subtitle" 
       appEditableContent 
       pageId="inicio" 
       contentId="blog-section-subtitle"
       contentType="text"></p>
  </div>
  
  <div *ngIf="ultimosBlogs.length" class="blog-cards-grid">
    <div *ngFor="let blog of ultimosBlogs.slice(0, 4)" class="modern-blog-card" (click)="selectBlog(blog)" style="cursor: pointer;">
      <!-- Imagen destacada -->
      <div class="card-image-wrapper">
        <img 
          *ngIf="blog.imageUrl" 
          [src]="blog.imageUrl" 
          alt="{{ blog.title }}" 
          class="card-image" 
        />
        <div *ngIf="!blog.imageUrl" class="card-image-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 48px; height: 48px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
          </svg>
        </div>
        <div class="card-overlay"></div>
        <h3 class="card-title">{{ blog.title }}</h3>
      </div>
      
      <!-- Contenido del card -->
      <div class="card-content">
      </div>
    </div>
  </div>
  
  <!-- Botón ver todos -->
  <div class="blog-section-footer">
    <a routerLink="/ver-blog" class="btn-view-all">
      Ver todos los artículos
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 20px; height: 20px;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" />
      </svg>
    </a>
  </div>
</div>

<!-- Paquetes y Tratamientos -->
<div class="paquetes-section">
  <div class="section-header">
    <h1 class="paquetes-title" 
        appEditableContent 
        pageId="inicio" 
        contentId="paquetes-section-title"
        contentType="text"></h1>
    <p class="paquetes-subtitle" 
       appEditableContent 
       pageId="inicio" 
       contentId="paquetes-section-subtitle"
       contentType="text"></p>
  </div>
  
  <div class="paquetes-grid">
    <div *ngFor="let paquete of paquetes" class="paquete-card" [class.destacado]="paquete.destacado">
      <!-- Badge destacado -->
      <div *ngIf="paquete.destacado" class="badge-destacado">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
          <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
        </svg>
        Destacado
      </div>
      
      <!-- Header del card -->
      <div class="paquete-header">
        <h3 class="paquete-nombre">{{ paquete.nombre }}</h3>
        <p class="paquete-descripcion">{{ paquete.descripcion }}</p>
      </div>
      
      <!-- Precio -->
      <div class="paquete-precio">
        <span class="precio-amount">${{ paquete.precio_nacional | number:'1.0-0' }}</span>
        <span class="precio-label">CLP</span>
      </div>
      
      <!-- Detalles -->
      <div class="paquete-detalles">
        <div class="detalle-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{{ paquete.duracion }} minutos por sesión</span>
        </div>
        <div class="detalle-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          <span>{{ paquete.sesiones }} sesión{{ paquete.sesiones > 1 ? 'es' : '' }}</span>
        </div>
        <div class="detalle-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" />
          </svg>
          <span>{{ paquete.modalidad === 'ambas' ? 'Presencial u Online' : paquete.modalidad === 'online' ? 'Online' : 'Presencial' }}</span>
        </div>
      </div>
      
      <!-- Botón de acción -->
      <a routerLink="/formulario" class="paquete-btn">
        Reservar
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 18px; height: 18px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
        </svg>
      </a>
    </div>
  </div>
  
  <!-- Mensaje si no hay paquetes -->
  <div *ngIf="!paquetes.length" class="no-paquetes">
    <p>No hay tratamientos disponibles en este momento.</p>
  </div>
</div>

<!-- Sección de Convenios -->
<div class="convenios-section">
  <div class="blog-titulo">
    <div class="additional-info">
      <h1 class="convenios-title" 
          appEditableContent 
          pageId="inicio" 
          contentId="convenios-title"
          contentType="text"></h1>
      <p appEditableContent 
         pageId="inicio" 
         contentId="convenios-description"
         contentType="html"></p>
    </div>
  </div>
</div>

<!-- Texto de Tarot Editable -->
<div class="card-container">
  <div class="text-section1">
    <div style="display: flex; flex-direction: column; align-items: center;">
      <h1 class="tarot-title" 
          style="text-align: center; margin-bottom: 1rem;"
          appEditableContent 
          pageId="inicio" 
          contentId="tarot-title"
          contentType="text"></h1>
      <p appEditableContent 
          pageId="inicio" 
          contentId="tarot-text"
          contentType="html"></p>
      <a href="/tarotista" class="btn">Ver más</a>
    </div>
  </div>
  
  <div class="image-section">
    <img *ngIf="getMediaSrc('tarot-image')"
         [src]="getMediaSrc('tarot-image')" 
         alt="Imagen de Servicios" 
         appEditableImage
         imageKey="tarot-image"
         pageId="inicio"
         (imageChange)="onImageChange($event, 'tarot-image')" />
  </div>
</div>

<!-- Sección de Comentarios -->
<div class="seccion-principal">
  <!-- Comentarios -->
  <div class="comentarios-card">
    <h2>Comentarios de Pacientes</h2>

    <!-- Mensaje si no hay comentarios -->
    <div *ngIf="comentarios.length === 0" class="comentario">
      <p style="text-align: center; color: #666;">Aún no hay comentarios. ¡Sé el primero en dejar tu experiencia!</p>
    </div>

    <!-- Lista de comentarios desde Supabase -->
    <div class="comentario" *ngFor="let comentario of comentarios">
      <p>"{{ comentario.comment_text }}"</p>
      <div class="info">
        <span>— {{ comentario.author_name }}</span>
        <span class="stars">{{ generarEstrellas(comentario.rating) }}</span>
      </div>
    </div>

    <!-- Formulario para nuevo comentario -->
    <div class="nuevo-comentario">
      <h3>Deja tu comentario</h3>
      
      <!-- Mensaje de feedback -->
      <div *ngIf="mensajeComentario" 
           [class.success-message]="mensajeComentario.includes('✅')"
           [class.error-message]="mensajeComentario.includes('❌')"
           style="padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 14px;">
        {{ mensajeComentario }}
      </div>

      <input 
        type="text" 
        [(ngModel)]="nuevoComentario.author_name" 
        placeholder="Tu nombre"
        [disabled]="enviandoComentario"
        style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;"
      />
      
      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Calificación:</label>
        <select 
          [(ngModel)]="nuevoComentario.rating" 
          [disabled]="enviandoComentario"
          style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
          <option [value]="5">★★★★★ (5 estrellas)</option>
          <option [value]="4">★★★★☆ (4 estrellas)</option>
          <option [value]="3">★★★☆☆ (3 estrellas)</option>
          <option [value]="2">★★☆☆☆ (2 estrellas)</option>
          <option [value]="1">★☆☆☆☆ (1 estrella)</option>
        </select>
      </div>

      <textarea 
        [(ngModel)]="nuevoComentario.comment_text" 
        placeholder="Escribe tu experiencia..."
        [disabled]="enviandoComentario"
      ></textarea>
      
      <button 
        (click)="enviarComentario()"
        [disabled]="enviandoComentario">
        {{ enviandoComentario ? 'Enviando...' : 'Enviar' }}
      </button>
    </div>
  </div>

<!-- Footer Profesional de Contacto -->
<footer class="footer-contacto">
  <div class="footer-container">
    <!-- Columna 1: Información -->
    <div class="footer-column">
      <h3 class="footer-heading">EMH Psicoterapia Online</h3>
      <p class="footer-description"
         appEditableContent 
         pageId="inicio" 
         contentId="footer-description"
         contentType="text">
        Apoyo psicológico profesional para tu bienestar emocional y mental.
        Sesiones presenciales y online.
      </p>
      <div class="footer-social">
        <a appEditableLink
           pageId="inicio" 
           linkKey="social-facebook"
           href="https://www.facebook.com/tuapoyopsicologico2.0" 
           target="_blank" 
           class="social-link" 
           title="Facebook">
          <img src="assets/face.avif" alt="Facebook" />
        </a>
        <a appEditableLink
           pageId="inicio" 
           linkKey="social-instagram"
           href="https://www.instagram.com/emhpsicoterapiaonline/" 
           target="_blank" 
           class="social-link" 
           title="Instagram">
          <img src="assets/insta.avif" alt="Instagram" />
        </a>
        <a appEditableLink
           pageId="inicio" 
           linkKey="social-tiktok"
           href="https://www.tiktok.com/@emhpsicoterapiaonline" 
           target="_blank" 
           class="social-link" 
           title="TikTok">
          <img src="assets/tik.avif" alt="TikTok" />
        </a>
        <a appEditableLink
           pageId="inicio" 
           linkKey="social-linkedin"
           href="https://www.linkedin.com/in/eduardo-márquez-huerta-7a840915/" 
           target="_blank" 
           class="social-link" 
           title="LinkedIn">
          <img src="assets/lin.avif" alt="LinkedIn" />
        </a>
      </div>
    </div>

    <!-- Columna 2: Enlaces Rápidos -->
    <div class="footer-column">
      <h3 class="footer-heading">Enlaces Rápidos</h3>
      <ul class="footer-links">
        <li><a routerLink="/ver-blog">Blog</a></li>
        <li><a routerLink="/formulario">Reservar Cita</a></li>
      </ul>
    </div>

    <!-- Columna 3: Contacto -->
    <div class="footer-column">
      <h3 class="footer-heading">Contacto</h3>
      <ul class="footer-contact">
        <li>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
          </svg>
          <a href="mailto:eduardo@emhpsicoterapia.cl">
            <span appEditableContent 
                  pageId="inicio" 
                  contentId="contact-email-display"
                  contentType="text">eduardo&#64;emhpsicoterapia.cl</span>
          </a>
        </li>
        <li>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
          </svg>
          <a appEditableLink
             pageId="inicio" 
             linkKey="contact-phone"
             href="tel:+56994739587">+56 9 9473 9587</a>
        </li>
        <li>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
          </svg>
          <span appEditableContent 
                pageId="inicio" 
                contentId="contact-location">Santiago, Chile</span>
        </li>
      </ul>
    </div>

    <!-- Columna 4: Encuéntranos en -->
    <div class="footer-column">
      <h3 class="footer-heading">Encuéntranos también en</h3>
      <div class="footer-platforms">
        <a appEditableLink
           pageId="inicio" 
           linkKey="platform-2x3"
           href="https://www.2x3.cl/profesional/emhpsicoterapiaonline" 
           target="_blank" 
           class="platform-btn">
          2x3
        </a>
        <a appEditableLink
           pageId="inicio" 
           linkKey="platform-psychology-today"
           href="https://www.psychologytoday.com/profile/1022969" 
           target="_blank" 
           class="platform-btn">
          Psychology Today
        </a>
      </div>
      <a appEditableLink
         pageId="inicio" 
         linkKey="whatsapp-footer"
         href="https://wa.me/56994739587?text=¡Hola!%20Me%20interesa%20tu%20servicio" 
         target="_blank" 
         class="whatsapp-footer-btn">
        <img src="assets/wtsp.avif" alt="WhatsApp" />
        <span>Contactar por WhatsApp</span>
      </a>
    </div>
  </div>

  <!-- Footer Bottom -->
  <div class="footer-bottom">
    <p>&copy; {{ currentYear }} EMH Psicoterapia Online. Todos los derechos reservados.</p>
    <div class="footer-bottom-links">
      <a href="#">Política de Privacidad</a>
      <span>·</span>
      <a href="#">Términos y Condiciones</a>
    </div>
  </div>
</footer>

<!-- Modal de detalle del blog -->
<div *ngIf="blogSeleccionado" class="detalle-blog">
  <div class="detalle-contenido">
    <button class="cerrar-btn" (click)="closeDetail()">✕</button>
    
    <!-- Información del Blog -->
    <div class="info-arriba">
      <img src="assets/h3.avif" alt="icono blog" />
      <div class="info-texto">
        <span class="sitio">emhpsicoterapiaonline.com</span>
        <span class="fecha">{{ blogSeleccionado.createdAt | date: 'longDate' }}</span>
        <span *ngIf="blogSeleccionado.creator" class="autor">
          Por: {{ blogSeleccionado.creator.username }}
        </span>
      </div>
    </div>
    
    <h3>{{ blogSeleccionado.title }}</h3>
    
    <!-- Render HTML content safely -->
    <div class="blog-content" [innerHTML]="getSafeHtml(blogSeleccionado.content)"></div>
    
    <!-- Video usando pipe -->
    <div *ngIf="blogSeleccionado.videoUrl" class="video-container">
      <iframe
        width="100%"
        height="450"
        [src]="blogSeleccionado.videoUrl | youtubeEmbed"
        frameborder="0"
        allowfullscreen>
      </iframe>
    </div>

  </div>
</div>
